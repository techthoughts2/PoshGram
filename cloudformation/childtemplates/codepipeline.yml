---
AWSTemplateFormatVersion: '2010-09-09'

Description: 'AUTOMATED: PoshGram - CodePipeline infrastructure resource deployment'

# Transform: 'AWS::Serverless-2016-10-31'

Parameters:
  ServiceName:
    Type: String
    Description: The name of the service being deployed. Used for Developer AWS Account Resource Names.

  ResourceType:
    Type: String
    Description: Determine the type of resource that will be deployed
    AllowedValues:
      - core
      - dev
      - test
      - prod

  GitHubRepositoryName:
    Type: String
    Description: The name of the GitHub repository that code-pipeline will source from

  GitHubOwner:
    Type: String
    Description: The name of the GitHub user or organization who owns the GitHub repository.

Resources:

  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html
  PoshGramCodePipelineCodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ServiceName}-CodePipelineCodeBuildBRole'
      Tags:
        - Key: ServiceName
          Value: !Ref ServiceName
        - Key: StackName
          Value: !Ref AWS::StackName
        - Key: ResourceType
          Value: !Ref ResourceType
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
            Action:
              - sts:AssumeRole
      Description: IAM Role for CodePipeline GitHub project
      # ManagedPolicyArns:
      #   - String
      # MaxSessionDuration: Integer
      Path: /
      # PermissionsBoundary: String
      Policies:
        - PolicyName: !Sub '${ServiceName}-CodePipelineCodeBuildPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # -
              #   Effect: Allow
              #   Action:
              #     - sns:Publish
              #   Resource:
              #     - !Ref PoshGramPipelineStatusUpdates
              - Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - !Sub
                    - '${ImportedBucketARN}'
                    - ImportedBucketARN: !ImportValue
                        'Fn::Sub': '${ServiceName}-PoshGramCICDEnhancementsArtifactS3BucketARN'
                  - !Sub
                    - '${ImportedBucketARN}/*'
                    - ImportedBucketARN: !ImportValue
                        'Fn::Sub': '${ServiceName}-PoshGramCICDEnhancementsArtifactS3BucketARN'
                  - !Sub
                    - '${ImportedBucketARN}'
                    - ImportedBucketARN: !ImportValue
                        'Fn::Sub': '${ServiceName}-PoshGramCICDMainArtifactS3BucketARN'
                  - !Sub
                    - '${ImportedBucketARN}/*'
                    - ImportedBucketARN: !ImportValue
                        'Fn::Sub': '${ServiceName}-PoshGramCICDMainArtifactS3BucketARN'
              - Effect: Allow
                Action:
                  - iam:ListRoles
                  - iam:PassRole
                  - sts:AssumeRole
                Resource:
                  - '*'
              - Effect: Allow
                Action:
                  - codebuild:StartBuild
                  - codebuild:BatchGetBuilds
                Resource:
                  - Fn::ImportValue:
                      !Sub "${ServiceName}-MainCBWindowspwshARN"
                  - Fn::ImportValue:
                      !Sub "${ServiceName}-MainCBLinuxpwshARN"
                  - Fn::ImportValue:
                      !Sub "${ServiceName}-EnhancementCBWindowspwshARN"
                  - Fn::ImportValue:
                      !Sub "${ServiceName}-EnhancementsCBLinuxpwshARN"
              # - Effect: Allow
              #   Action:
              #     - kms:*
              #   Resource: !GetAtt KMSKey.Arn
              - Effect: Allow
                Action:
                  - codestar-connections:GetConnection
                  - codestar-connections:ListConnections
                  - codestar-connections:GetInstallationUrl
                  - codestar-connections:GetIndividualAccessToken
                  - codestar-connections:ListInstallationTargets
                  - codestar-connections:StartOAuthHandshake
                  - codestar-connections:UseConnection
                Resource: !Sub 'arn:${AWS::Partition}:codestar-connections:${AWS::Region}:${AWS::AccountId}:connection/ecfb22c8-ac43-49d4-9980-0345f9fd0ae2'

  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codepipeline-pipeline.html
  PoshGramEnhancementsCICDPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      ArtifactStore:
        Type: S3
        Location:
          Fn::ImportValue:
            !Sub "${ServiceName}-PoshGramCICDEnhancementsArtifactS3Bucket"
      # ArtifactStores:
      #   - ArtifactStoreMap
      # DisableInboundStageTransitions:
      #   - StageTransition
      Name: !Sub '${ServiceName}-Enhancements-CodePipeline'
      RestartExecutionOnUpdate: false
      RoleArn: !GetAtt PoshGramCodePipelineCodeBuildRole.Arn
      Tags:
        - Key: ServiceName
          Value: !Ref ServiceName
        - Key: StackName
          Value: !Ref AWS::StackName
        - Key: ResourceType
          Value: !Ref ResourceType
      # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-codepipeline-pipeline-stages.html
      # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-codepipeline-pipeline-stages-actions.html
      # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-codepipeline-pipeline-stages-actions-actiontypeid.html
      # https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html#actions-valid-providers
      # https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference-GitHub.html
      # https://docs.aws.amazon.com/codepipeline/latest/userguide/update-change-detection.html#update-change-detection-cfn-github
      Stages:
        - Name: Source
          Actions:
            - Name: GitHubSource
              ActionTypeId:
                Version: '1'
                Owner: AWS
                Category: Source
                Provider: CodeStarSourceConnection
              Configuration:
                ConnectionArn: !Sub 'arn:${AWS::Partition}:codestar-connections:${AWS::Region}:${AWS::AccountId}:connection/ecfb22c8-ac43-49d4-9980-0345f9fd0ae2'
                FullRepositoryId: !Sub '${GitHubOwner}/${GitHubRepositoryName}'
                BranchName: Enhancements
              # InputArtifacts:
              #   - InputArtifact
              # Namespace: String
              # OutputArtifactFormat: "CODE_ZIP"
              OutputArtifacts:
                - Name: GitHubSource
              # Region: String
              # RoleArn: String
              RunOrder: 1
        - Name: Enhancements-Validation
          Actions:
            - Name: Enhancements-CB-Linux
              InputArtifacts:
                - Name: GitHubSource
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: '1'
                Provider: CodeBuild
              # OutputArtifacts:
              #   - Name: CFNTemplateArtifact
              Configuration:
                ProjectName:
                  Fn::ImportValue: !Sub "${ServiceName}-EnhancementsCBLinuxpwshName"
              # Namespace: String
              # Region: String
              # RoleArn: String
              RunOrder: 1
            - Name: Enhancements-CB-Windows
              InputArtifacts:
                - Name: GitHubSource
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: '1'
                Provider: CodeBuild
              # OutputArtifacts:
              #   - Name: CFNTemplateArtifact
              Configuration:
                ProjectName:
                  Fn::ImportValue: !Sub "${ServiceName}-EnhancementsCBLinuxpwshName"
              # Namespace: String
              # Region: String
              # RoleArn: String
              RunOrder: 2

Outputs:

  PoshGramEnhancementsCICDPipelineName:
    Description: The name of the PoshGram Enhancements CICD Pipeline
    Value: !Ref PoshGramEnhancementsCICDPipeline
    Export:
      Name: !Sub '${ServiceName}-PoshGramEnhancementsCICDPipelineName'
